{% extends 'base_new_dashboard.html' %}

{% block title %}Meus Pacientes - NutriVida Pro{% endblock %}

{% block body_content %}
<div class="dashboard">
    <!-- Header -->
    <div class="header">
        <div class="user-info">
            <div class="user-details">
                <h1>Meus Pacientes</h1>
                <p>{{ patients.paginator.count }} pacientes cadastrados</p>
            </div>
        </div>
        <div class="header-actions">
            <form method="get" class="search-form">
                <input type="text" name="q" value="{{ search_query }}" placeholder="Buscar por nome...">
                <button type="submit"><i class="fas fa-search"></i></button>
            </form>
            <form method="get" class="sort-form">
                <select name="sort" onchange="this.form.submit()" class="btn btn-secondary">
                    <option value="-created_at" {% if sort_by == '-created_at' %}selected{% endif %}>Mais Recentes</option>
                    <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>Mais Antigos</option>
                    <option value="user__name" {% if sort_by == 'user__name' %}selected{% endif %}>Nome (A-Z)</option>
                    <option value="-user__name" {% if sort_by == '-user__name' %}selected{% endif %}>Nome (Z-A)</option>
                </select>
            </form>
            <a href="{% url 'patients:create' %}" class="btn btn-primary">
                <i class="fas fa-user-plus"></i> Novo Paciente
            </a>
        </div>
    </div>

    <!-- Patient Cards Grid -->
    <div class="patient-grid">
        {% for patient in patients %}
        <div class="patient-card">
            <div class="patient-card-header">
                <div class="patient-card-avatar">
                    {% if patient.user.profile_picture %}
                        <img src="{{ patient.user.profile_picture.url }}" alt="{{ patient.user.name }}">
                    {% else %}
                        <img src="https://i.pravatar.cc/80?u={{ patient.user.id }}" alt="Paciente">
                    {% endif %}
                </div>
                <div class="patient-card-info">
                    <h3 class="patient-card-name">{{ patient.user.name }}</h3>
                    <p class="patient-card-email">{{ patient.user.email }}</p>
                </div>
            </div>
            <div class="patient-card-body">
                <p><i class="fas fa-phone"></i> {{ patient.phone|default:"Não informado" }}</p>
                <p><i class="fas fa-calendar-alt"></i> Cadastrado em: {{ patient.created_at|date:"d/m/Y" }}</p>
            </div>
            <div class="patient-card-footer">
                <a href="{% url 'patients:detail' patient.id %}" class="btn btn-secondary">Ver Perfil</a>
            </div>
        </div>
        {% empty %}
        <div class="card" style="grid-column: 1 / -1;">
            <div class="text-center py-10">
                <i class="fas fa-users text-6xl text-gray-300 mb-4"></i>
                <p class="text-gray-500">Nenhum paciente cadastrado ainda.</p>
                <p class="text-sm text-gray-400 mt-2">Clique em "Novo Paciente" para começar.</p>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if patients.has_other_pages %}
    <div class="pagination">
        {% if patients.has_previous %}
            <a href="?page=1&q={{ search_query }}&sort={{ sort_by }}" class="page-item">&laquo;</a>
            <a href="?page={{ patients.previous_page_number }}&q={{ search_query }}&sort={{ sort_by }}" class="page-item">&lsaquo;</a>
        {% endif %}

        {% for num in patients.paginator.page_range %}
            {% if patients.number == num %}
                <span class="page-item current">{{ num }}</span>
            {% elif num > patients.number|add:'-3' and num < patients.number|add:'3' %}
                <a href="?page={{ num }}&q={{ search_query }}&sort={{ sort_by }}" class="page-item">{{ num }}</a>
            {% endif %}
        {% endfor %}

        {% if patients.has_next %}
            <a href="?page={{ patients.next_page_number }}&q={{ search_query }}&sort={{ sort_by }}" class="page-item">&rsaquo;</a>
            <a href="?page={{ patients.paginator.num_pages }}&q={{ search_query }}&sort={{ sort_by }}" class="page-item">&raquo;</a>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}